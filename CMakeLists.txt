cmake_minimum_required(VERSION 3.20)
set(CMAKE_EXPORT_COMPILE_COMMANDS ON)
project(ParticleSim VERSION 0.0.1)

set(CMAKE_CXX_STANDARD 23)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
include(FetchContent)

set(SDL_STATIC ON)
include(externalFunctions.cmake)

# ä¸‹è½½æ‰€æœ‰ä¾èµ–
download_all_dependencies()
# ----------------------------------------
# é…ç½® SDL3 è·¯å¾„ï¼ˆé¡¹ç›®å†…ç¬¬ä¸‰æ–¹åº“ï¼‰
# ----------------------------------------
set(SDL3_BASE_DIR "${CMAKE_SOURCE_DIR}/third_party/SDL3")
set(SDL3_IMAGE_BASE_DIR "${CMAKE_SOURCE_DIR}/third_party/SDL3_image")
set(SDL2_MIXER_BASE_DIR "${CMAKE_SOURCE_DIR}/third_party/SDL2_mixer")
set(SDL3_TTF_BASE_DIR "${CMAKE_SOURCE_DIR}/third_party/SDL3_ttf")

# å¤´æ–‡ä»¶è·¯å¾„ï¼ˆç›´æ¥æŒ‡å®šï¼‰
set(SDL3_INCLUDE_DIR "${SDL3_BASE_DIR}/include")
set(SDL3_IMAGE_INCLUDE_DIR "${SDL3_IMAGE_BASE_DIR}/include")
set(SDL2_MIXER_INCLUDE_DIR "${SDL2_MIXER_BASE_DIR}/include")
set(SDL3_TTF_INCLUDE_DIR "${SDL3_TTF_BASE_DIR}/include")

# åŠ¨æ€åº“/é™æ€åº“è·¯å¾„ï¼ˆè‡ªåŠ¨é€‚é…å¹³å°å’Œæ¶æ„ï¼‰
if(WIN32)
    # è‡ªåŠ¨æ£€æµ‹æ¶æ„ï¼ˆx64 æˆ– x86ï¼‰
    if(CMAKE_SIZEOF_VOID_P EQUAL 8)
        set(SDL3_LIB_ARCH_DIR "x64")
    else()
        set(SDL3_LIB_ARCH_DIR "x86")
    endif()

    # è®¾ç½®åº“æ–‡ä»¶æœç´¢è·¯å¾„
    set(SDL3_LIB_DIR "${SDL3_BASE_DIR}/lib/${SDL3_LIB_ARCH_DIR}")
    set(SDL3_IMAGE_LIB_DIR "${SDL3_IMAGE_BASE_DIR}/lib/${SDL3_LIB_ARCH_DIR}")
    set(SDL2_MIXER_LIB_DIR "${SDL2_MIXER_BASE_DIR}/lib/${SDL3_LIB_ARCH_DIR}")
    set(SDL3_TTF_LIB_DIR "${SDL3_TTF_BASE_DIR}/lib/${SDL3_LIB_ARCH_DIR}")
else()
    # Linux/macOS ä½¿ç”¨ç»Ÿä¸€è·¯å¾„
    message(STATUS "SDL3_LIB_DIR: ${SDL3_LIB_DIR}")
    set(SDL3_LIB_DIR "${SDL3_BASE_DIR}/lib/arm64")
    set(SDL3_IMAGE_LIB_DIR "${SDL3_IMAGE_BASE_DIR}/lib/arm64")
    set(SDL2_MIXER_LIB_DIR "${SDL2_MIXER_BASE_DIR}/lib/${SDL3_LIB_ARCH_DIR}")
    set(SDL3_TTF_LIB_DIR "${SDL3_TTF_BASE_DIR}/lib/arm64")
endif()

# æŸ¥æ‰¾ SDL3 åº“æ–‡ä»¶
find_library(SDL3_LIBRARY
    NAMES SDL3 SDL3-static   # åŠ¨æ€åº“å’Œé™æ€åº“åç§°
    PATHS ${SDL3_LIB_DIR}
    NO_DEFAULT_PATH          # ç¦æ­¢æœç´¢ç³»ç»Ÿè·¯å¾„
)
message(STATUS "SDL3_LIBRARY: ${SDL3_LIBRARY}")
message(STATUS "SDL3_INCLUDE_DIR: ${SDL3_INCLUDE_DIR}")

if(NOT SDL3_LIBRARY)
    message(FATAL_ERROR "SDL3 library not found in: ${SDL3_LIB_DIR}")
endif()

# æŸ¥æ‰¾ SDL3_image åº“æ–‡ä»¶
find_library(SDL3_IMAGE_LIBRARY
    NAMES SDL3_image SDL3_image-static   # åŠ¨æ€åº“å’Œé™æ€åº“åç§°
    PATHS ${SDL3_IMAGE_LIB_DIR}
    NO_DEFAULT_PATH          # ç¦æ­¢æœç´¢ç³»ç»Ÿè·¯å¾„
)
message(STATUS "SDL3_IMAGE_LIBRARY: ${SDL3_IMAGE_LIBRARY}")
message(STATUS "SDL3_IMAGE_INCLUDE_DIR: ${SDL3_IMAGE_INCLUDE_DIR}")

if(NOT SDL3_IMAGE_LIBRARY)
    message(FATAL_ERROR "SDL3_image library not found in: ${SDL3_IMAGE_LIB_DIR}")
endif()

# æŸ¥æ‰¾ SDL2_mixer åº“æ–‡ä»¶
find_library(SDL2_MIXER_LIBRARY
    NAMES SDL2_mixer SDL2_mixer-static   # åŠ¨æ€åº“å’Œé™æ€åº“åç§°
    PATHS ${SDL2_MIXER_LIB_DIR}
    NO_DEFAULT_PATH          # ç¦æ­¢æœç´¢ç³»ç»Ÿè·¯å¾„
)
message(STATUS "SDL2_MIXER_LIBRARY: ${SDL2_MIXER_LIBRARY}")
message(STATUS "SDL2_MIXER_INCLUDE_DIR: ${SDL2_MIXER_INCLUDE_DIR}")

if(NOT SDL2_MIXER_LIBRARY)
    message(FATAL_ERROR "SDL2_mixer library not found in: ${SDL2_MIXER_LIB_DIR}")
endif()

# æŸ¥æ‰¾ SDL3_ttf åº“æ–‡ä»¶
find_library(SDL3_TTF_LIBRARY
    NAMES SDL3_ttf SDL3_ttf-static   # åŠ¨æ€åº“å’Œé™æ€åº“åç§°
    PATHS ${SDL3_TTF_LIB_DIR}
    NO_DEFAULT_PATH          # ç¦æ­¢æœç´¢ç³»ç»Ÿè·¯å¾„
)
message(STATUS "SDL3_TTF_LIBRARY: ${SDL3_TTF_LIBRARY}")
message(STATUS "SDL3_TTF_INCLUDE_DIR: ${SDL3_TTF_INCLUDE_DIR}")
if(NOT SDL3_TTF_LIBRARY)
    message(FATAL_ERROR "SDL3_ttf library not found in: ${SDL3_TTF_LIB_DIR}")
endif()

# ----------------------------------------
# é…ç½® Vulkan
# ----------------------------------------
find_package(Vulkan REQUIRED)
message(STATUS "Vulkan found: ${Vulkan_INCLUDE_DIRS}")
message(STATUS "Vulkan found: ${Vulkan_LIBRARY}")
message(STATUS "Vulkan found: ${Vulkan_FOUND}")


FetchContent_Declare(
    glm
    GIT_REPOSITORY https://github.com/g-truc/glm.git
    GIT_TAG 1.0.1
)

FetchContent_Declare(
    spdlog
    GIT_REPOSITORY https://github.com/gabime/spdlog.git
    GIT_TAG v1.15.3
)

message(NOTICE "ğŸ”· load glm")
FetchContent_MakeAvailable(glm)
message(NOTICE "âœ… glm loaded")

message(NOTICE "ğŸ”· load spdlog")
FetchContent_MakeAvailable(spdlog)
message(NOTICE "âœ… spdlog loaded")

# ----------------------------------------
# åˆ›å»ºå¯æ‰§è¡Œæ–‡ä»¶
# ----------------------------------------
file(GLOB_RECURSE PROJECT_RENDER_SOURCE_FILES "src/render/*.cpp")
file(GLOB_RECURSE PROJECT_HEADER_DIRS "src/*.h")

add_executable(${PROJECT_NAME} 
src/main.cpp
src/ParticleSim.cpp
#src/texture.c
# src/vulkan_sdl_demo.cpp
${PROJECT_RENDER_SOURCE_FILES}
)

set(INCLUDE_DIRS "")
foreach(HEADER ${PROJECT_HEADER_DIRS})
    get_filename_component(DIR ${HEADER} DIRECTORY)
    list(APPEND INCLUDE_DIRS ${DIR})
endforeach()
list(REMOVE_DUPLICATES INCLUDE_DIRS)

message(STATUS "ğŸ”· include directories: ${INCLUDE_DIRS}")

# æ·»åŠ å¤´æ–‡ä»¶åŒ…å«è·¯å¾„
target_include_directories(${PROJECT_NAME} PRIVATE
    ${SDL3_INCLUDE_DIR}       # SDL3 å¤´æ–‡ä»¶è·¯å¾„
    ${SDL3_IMAGE_INCLUDE_DIR} # SDL3_image å¤´æ–‡ä»¶è·¯å¾„
    ${SDL2_MIXER_INCLUDE_DIR} # SDL2_mixer å¤´æ–‡ä»¶è·¯å¾„
    ${SDL3_TTF_INCLUDE_DIR}   # SDL3_ttf å¤´æ–‡ä»¶è·¯å¾„
    ${Vulkan_INCLUDE_DIR}     # Vulkan å¤´æ–‡ä»¶
    ${INCLUDE_DIRS}
    third_party/stb
)

# é“¾æ¥åº“æ–‡ä»¶
target_link_libraries(${PROJECT_NAME} PRIVATE
    Vulkan::Vulkan           # Vulkan åº“
    ${SDL3_LIBRARY}          # SDL3 åº“æ–‡ä»¶
    ${SDL3_IMAGE_LIBRARY}    # SDL3_image åº“æ–‡ä»¶
    ${SDL2_MIXER_LIBRARY}    # SDL2_mixer åº“æ–‡ä»¶
    ${SDL3_TTF_LIBRARY}      # SDL3_ttf åº“æ–‡ä»¶
    glm                      # glm åº“
    spdlog                   # spdlog åº“
)

if (NOT CMAKE_BUILD_TYPE STREQUAL "Debug" AND WIN32)
    set_target_properties(${PROJECT_NAME} PROPERTIES LINK_FLAGS "/SUBSYSTEM:WINDOWS /ENTRY:mainCRTStartup")
endif()

target_compile_definitions(${PROJECT_NAME} PRIVATE
    PROJECT_NAME="${PROJECT_NAME}"
    PROJECT_VERSION_MAJOR=${PROJECT_VERSION_MAJOR}
    PROJECT_VERSION_MINOR=${PROJECT_VERSION_MINOR}
    PROJECT_VERSION_PATCH=${PROJECT_VERSION_PATCH}
    PROJECT_VK_VERSION_MAJOR=1
    PROJECT_VK_VERSION_MINOR=3
    PROJECT_VK_VERSION_PATCH=268

    $<$<CONFIG:Debug>:DEBUG_BUILD>
    $<$<NOT:$<CONFIG:Debug>>:RELEASE_BUILD>
    $<$<BOOL:${WIN32}>:OS_WINDOWS>
    $<$<BOOL:${APPLE}>:OS_MACOS>
    $<$<BOOL:${UNIX}>:OS_LINUX>
)

# ----------------------------------------
# å¹³å°ç‰¹å®šé…ç½®ï¼ˆWindowsï¼‰
# ----------------------------------------
if(WIN32)
    # è‡ªåŠ¨å¤åˆ¶ SDL3.dll åˆ°è¾“å‡ºç›®å½•
    if(EXISTS "${SDL3_LIB_DIR}/SDL3.dll")
        add_custom_command(TARGET ${PROJECT_NAME} POST_BUILD
            COMMAND ${CMAKE_COMMAND} -E copy
                "${SDL3_LIB_DIR}/SDL3.dll"
                "$<TARGET_FILE_DIR:${PROJECT_NAME}>"
        )
    else()
        message(WARNING "SDL3.dll not found in ${SDL3_LIB_DIR}")
    endif()

    # è‡ªåŠ¨å¤åˆ¶ SDL3_image.dll åˆ°è¾“å‡ºç›®å½•
    if(EXISTS "${SDL3_IMAGE_LIB_DIR}/SDL3_image.dll")
        add_custom_command(TARGET ${PROJECT_NAME} POST_BUILD
            COMMAND ${CMAKE_COMMAND} -E copy
                "${SDL3_IMAGE_LIB_DIR}/SDL3_image.dll"
                "$<TARGET_FILE_DIR:${PROJECT_NAME}>"
        )
    else()
        message(WARNING "SDL3_image.dll not found in ${SDL3_IMAGE_LIB_DIR}")
    endif()

    # è‡ªåŠ¨å¤åˆ¶ SDL2_mixer.dll åˆ°è¾“å‡ºç›®å½•
    if(EXISTS "${SDL2_MIXER_LIB_DIR}/SDL2_mixer.dll")
        add_custom_command(TARGET ${PROJECT_NAME} POST_BUILD
            COMMAND ${CMAKE_COMMAND} -E copy
                "${SDL2_MIXER_LIB_DIR}/SDL2_mixer.dll"
                "$<TARGET_FILE_DIR:${PROJECT_NAME}>"
        )
    else()
        message(WARNING "SDL2_mixer.dll not found in ${SDL2_MIXER_LIB_DIR}")
    endif()

    # è‡ªåŠ¨å¤åˆ¶ SDL3_ttf.dll åˆ°è¾“å‡ºç›®å½•
    if(EXISTS "${SDL3_TTF_LIB_DIR}/SDL3_ttf.dll")
        add_custom_command(TARGET ${PROJECT_NAME} POST_BUILD
            COMMAND ${CMAKE_COMMAND} -E copy
                "${SDL3_TTF_LIB_DIR}/SDL3_ttf.dll"
                "$<TARGET_FILE_DIR:${PROJECT_NAME}>"
        )
    else()
        message(WARNING "SDL3_ttf.dll not found in ${SDL3_TTF_LIB_DIR}")
    endif()

    # é“¾æ¥ Windows ç³»ç»Ÿåº“
    target_link_libraries(${PROJECT_NAME} PRIVATE
        user32.lib
        shell32.lib
        dxguid.lib
    )
endif()
